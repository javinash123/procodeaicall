# Deployment Guide for nijvox.com (AWS Amazon Linux 2023 + Apache)

This project is a full-stack Node.js application (Express + React). To deploy it on your AWS EC2 instance, follow these steps:

## 1. Prerequisites on EC2
Login to your EC2 instance and install the necessary dependencies:
```bash
# Update system
sudo dnf update -y

# Install Node.js (LTS version recommended)
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo dnf install -y nodejs

# Install Git (if not already installed)
sudo dnf install -y git

# Install PM2 to manage the Node.js process
sudo npm install -y -g pm2
```

## 2. Database Setup
The app uses MongoDB. You can either use MongoDB Atlas (recommended) or install MongoDB locally on the EC2 instance.
If using a remote MongoDB, ensure you have the connection string ready.

## 3. Prepare the Application
Upload the project files to your server (e.g., to `/var/www/nijvox`). 
You should include the `dist` folder generated by the build process.

```bash
cd /var/www/nijvox
npm install --production
```

## 4. Environment Variables
Create a `.env` file in the project root:
```env
NODE_ENV=production
PORT=5000
MONGODB_URI=your_mongodb_connection_string
SESSION_SECRET=your_random_secret_string
```

## 5. Running the Application
Use PM2 to start the server:
```bash
pm2 start dist/index.cjs --name nijvox
pm2 save
pm2 startup
```

## 6. Apache Reverse Proxy Configuration
To serve the app on `https://nijvox.com/`, configure Apache as a reverse proxy.

### A. Disable Default Welcome Page
On Amazon Linux, the default welcome page can override your settings. Remove it:
```bash
sudo rm -f /etc/httpd/conf.d/welcome.conf
```

### B. Virtual Host Configuration
Create a virtual host configuration (e.g., `/etc/httpd/conf.d/nijvox.conf`). 
**Crucial:** Remove any `DocumentRoot` lines from this file if they exist, as they can cause Apache to serve files instead of proxying to Node.js.
```apache
<VirtualHost *:80>
    ServerName nijvox.com
    ServerAlias www.nijvox.com
    
    # Simple redirect to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName nijvox.com
    ServerAlias www.nijvox.com
    
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    SSLCertificateChainFile /path/to/your/chain.crt

    # Disable directory listing and ensure proxy takes precedence
    Options -Indexes
    ProxyRequests Off
    ProxyPreserveHost On

    # Proxy all requests to Node.js
    ProxyPass / http://127.0.0.1:5000/
    ProxyPassReverse / http://127.0.0.1:5000/

    # Ensure Apache can connect to the Node.js port
    <Proxy *>
        Order allow,deny
        Allow from all
    </Proxy>

    ErrorLog /var/log/httpd/nijvox-error.log
    CustomLog /var/log/httpd/nijvox-access.log combined
</VirtualHost>
```

### C. SELinux Permissions (Important)
If SELinux is enabled, Apache might be blocked from connecting to your Node.js app:
```bash
sudo setsebool -P httpd_can_network_connect 1
```

Restart Apache:
```bash
sudo systemctl restart httpd
```

## 7. Troubleshooting "Server Test Message"
If you see a simple "express" or "test" message instead of your website:
1. **Check NODE_ENV**: Ensure `NODE_ENV=production` is set in your `.env` file or PM2 process. The app only serves the frontend in production mode.
2. **Verify Dist Folder**: Ensure the `dist/public` folder exists and contains `index.html`.
3. **Static Path**: In `server/static.ts`, the app looks for a folder named `public` relative to the script. When running from `dist/index.cjs`, it looks for `dist/public`. Ensure your folder structure on the server is:
   ```
   /var/www/nijvox/
   ├── dist/
   │   ├── index.cjs
   │   └── public/
   │       └── index.html
   ├── .env
   └── package.json
   ```
4. **Permissions**: Ensure the user running the Node process has read permissions for the `dist` directory.
5. **Apache Configuration**: Ensure your Apache `ProxyPass` is pointing to the correct port (default 5000) and that there are no other virtual hosts overriding your configuration.
